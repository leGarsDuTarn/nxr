<!-- HERO -->
<section class="admin-dashboard banner-dashboard">
  <div class="container py-5">
    <h1 class="display-5 fw-bold mb-1">Bonjour <%= current_user.first_name %></h1>
    <p class="lead mb-0">Bienvenue sur ton espace membre</p>
  </div>
</section>

<!-- Mes inscriptions -->
<section class="container my-5">
  <% has_registrations = @registrations.present? %>

  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <h2 class="mb-0 text-start fs-2 fw-bold text-uppercase">
      <i class="fas fa-user-check me-2"></i>Mes inscriptions
    </h2>
  </div>

  <% if has_registrations %>
    <div class="home-carousel"
     data-controller="home-carousel"
     data-home-carousel-step-value="item">
  <button type="button"
          class="home-carousel__nav home-carousel__nav--prev carousel-nav prev"
          data-action="click->home-carousel#prev"
          data-home-carousel-target="prevButton"
          aria-label="Précédent">‹</button>

  <button type="button"
          class="home-carousel__nav home-carousel__nav--next carousel-nav next"
          data-action="click->home-carousel#next"
          data-home-carousel-target="nextButton"
          aria-label="Suivant">›</button>

  <div class="home-carousel__track"
       data-home-carousel-target="track">
        <% @registrations.each do |registration| %>
          <% reg = registration.registerable %>
          <div class="home-carousel__item">
            <article class="card card-admin shadow-sm rounded-4 h-100 overflow-hidden">
              <!-- Media -->
              <div class="ratio ratio-4x3 bg-dark">
                <% if reg.respond_to?(:image) && reg.image&.attached? %>
                  <%= image_tag reg.image, class: "card-img-top object-cover", alt: (reg.respond_to?(:name) ? reg.name : reg.try(:title)) %>
                <% else %>
                  <%# fallback par type pour garder la cohérence visuelle %>
                  <% fallback =
                       case registration.registerable_type
                       when 'Race'     then 'race_flag.png'
                       when 'Training' then 'training_img.png'
                       else 'logo_mcnc_3.png'
                       end %>
                  <%= image_tag fallback, class: "card-img-top object-contain p-3",
                        alt: (reg.respond_to?(:name) ? reg.name : reg.try(:title) || registration.registerable_type) %>
                <% end %>
              </div>

              <!-- Body -->
              <div class="card-body d-flex flex-column">
                <!-- Titre -->
                <h3 class="h6 fw-bold mb-2 text-truncate">
                  <%= reg.respond_to?(:name) ? reg.name : reg.try(:title) || registration.registerable_type %>
                </h3>

                <!-- Date de l'événement -->
                <% if reg.respond_to?(:date) && reg.date.present? %>
                  <p class="text-tertiary small mb-2">
                    <i class="far fa-calendar-alt me-1"></i>
                    <%= l(reg.date, format: "%d %B %Y") %>
                  </p>
                <% end %>

                <!-- Informations de statut et inscription -->
                <div class="mb-3">
                  <!-- Date d'inscription -->
                  <div class="text-tertiary small mb-2">
                    <i class="far fa-clipboard me-1"></i>
                    Inscrit le <%= l(registration.created_at, format: :short) %>
                  </div>

                  <!-- Statut -->
                  <% if registration.respond_to?(:status) && registration.status.present? %>
                    <% status = registration.status.to_s %>
                    <% status_color = case status
                      when "validated" then "badge-validated"
                      when "rejected"  then "badge-rejected"
                      else "badge-pending"
                    end %>
                    <% status_icon = case status
                      when "validated" then "fa-check-circle"
                      when "rejected"  then "fa-times-circle"
                      else "fa-hourglass-half"
                    end %>

                    <div class="d-flex align-items-center gap-5">
                      <span class="small text-tertiary me-2">
                        <i class="fas fa-traffic-light me-2"></i>Statut
                      </span>
                      <span class="badge rounded-pill d-inline-flex align-items-center gap-1 <%= status_color %>"
                            title="<%= status.humanize %>">
                        <i class="fas <%= status_icon %>"></i>
                        <%= status.humanize %>
                      </span>
                    </div>
                  <% end %>
                </div>

                <!-- Actions (CTA en bas) -->
                <div class="mt-auto">
                  <div class="d-flex align-items-center justify-content-between">
                    <!-- Bouton principal -->
                    <%= link_to polymorphic_path([:members, reg]),
                          class: "btn-nxr small d-inline-flex align-items-center" do %>
                      <i class="fas fa-search me-1"></i>Voir
                    <% end %>

                    <!-- Actions secondaires -->
                    <div class="btn-toolbar gap-2">
                      <%= link_to polymorphic_path([:members, reg, registration]),
                            class: "btn btn-icon btn-edit-orange",
                            title: "Voir mon inscription",
                            aria: { label: "Voir mon inscription" } do %>
                        <i class="fa-solid fa-pen-to-square"></i>
                      <% end %>

                      <%= link_to polymorphic_path([:members, reg, registration]),
                            data: {
                              turbo_method: :delete,
                              turbo_confirm: "Es-tu sûr de vouloir annuler ton inscription ?"
                            },
                            class: "btn btn-icon btn-delete-red",
                            title: "Annuler mon inscription",
                            aria: { label: "Annuler mon inscription" } do %>
                        <i class="fas fa-times"></i>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </article>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="card-homepage shadow-sm rounded-4 text-center p-5 mx-auto" style="max-width: 640px;">
      <div class="mb-3">
        <i class="far fa-clipboard fa-3x"></i>
      </div>
      <h3 class="h5 fw-bold mb-2">Aucune inscription</h3>
      <p class="mb-0">Inscris-toi à une activité pour la voir apparaître ici.</p>
    </div>
  <% end %>
</section>

<!-- Courses -->
<section class="container my-5">
  <% has_races = @races.present? %>

  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <h2 class="mb-0 text-start fs-2 fw-bold text-uppercase">
      <i class="fas fa-flag-checkered me-2"></i>Les courses à venir
    </h2>
  </div>

  <% if has_races %>
    <div class="home-carousel"
     data-controller="home-carousel"
     data-home-carousel-step-value="item">
  <button type="button"
          class="home-carousel__nav home-carousel__nav--prev carousel-nav prev"
          data-action="click->home-carousel#prev"
          data-home-carousel-target="prevButton"
          aria-label="Précédent">‹</button>

  <button type="button"
          class="home-carousel__nav home-carousel__nav--next carousel-nav next"
          data-action="click->home-carousel#next"
          data-home-carousel-target="nextButton"
          aria-label="Suivant">›</button>

  <div class="home-carousel__track"
       data-home-carousel-target="track">
        <% @races.each do |race| %>
          <div class="home-carousel__item">
            <article class="card card-admin shadow-sm rounded-4 h-100 overflow-hidden">
              <div class="ratio ratio-4x3 bg-dark">
                <% if race.image&.attached? %>
                  <%= image_tag race.image, class: "card-img-top object-cover", alt: race.name %>
                <% else %>
                  <%= image_tag "race_flag.png", class: "card-img-top object-contain p-3", alt: race.name %>
                <% end %>
              </div>

              <div class="card-body d-flex flex-column">
                <h3 class="h6 fw-bold mb-2"><%= race.name %></h3>
                <p class="text-tertiary small mb-3">
                  <i class="far fa-clock me-1"></i>
                  <%= l(race.date, format: "%d %B %Y") %>
                </p>

                <div class="mt-auto d-flex align-items-center justify-content-between">
                  <%= link_to members_race_path(race), class: "stretched-link btn-nxr small" do %>
                    <i class="fas fa-search me-1"></i> Voir la fiche
                  <% end %>
                </div>
              </div>
            </article>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="card-homepage shadow-sm rounded-4 text-center p-5 mx-auto" style="max-width: 640px;">
      <div class="mb-3"><i class="far fa-calendar-times fa-3x"></i></div>
      <h3 class="h5 fw-bold mb-2">Aucune course pour le moment</h3>
      <p class="mb-0">Dès qu’une course est publiée, elle s’affiche ici.</p>
    </div>
  <% end %>
</section>

<!-- Entraînements -->
<section class="container my-5">
  <% has_trainings = @trainings.present? %>

  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <h2 class="mb-0 text-start fs-2 fw-bold text-uppercase">
      <i class="far fa-hand-peace me-2"></i>Les entraînements à venir
    </h2>
  </div>

  <% if has_trainings %>
    <div class="home-carousel"
     data-controller="home-carousel"
     data-home-carousel-step-value="item">
  <button type="button"
          class="home-carousel__nav home-carousel__nav--prev carousel-nav prev"
          data-action="click->home-carousel#prev"
          data-home-carousel-target="prevButton"
          aria-label="Précédent">‹</button>

  <button type="button"
          class="home-carousel__nav home-carousel__nav--next carousel-nav next"
          data-action="click->home-carousel#next"
          data-home-carousel-target="nextButton"
          aria-label="Suivant">›</button>

  <div class="home-carousel__track"
       data-home-carousel-target="track">
        <% @trainings.each do |training| %>
          <div class="home-carousel__item">
            <article class="card card-admin shadow-sm rounded-4 h-100 overflow-hidden">
              <div class="ratio ratio-4x3 bg-dark">
                <% if training.image&.attached? %>
                  <%= image_tag training.image, class: "card-img-top object-cover", alt: training.name %>
                <% else %>
                  <%= image_tag "training_img.png", class: "card-img-top object-contain p-3", alt: training.name %>
                <% end %>
              </div>

              <div class="card-body d-flex flex-column">
                <h3 class="h6 fw-bold mb-2"><%= training.name %></h3>
                <p class="text-tertiary small mb-3">
                  <i class="far fa-clock me-1"></i>
                  <%= l(training.date, format: "%d %B %Y") %>
                </p>

                <div class="mt-auto d-flex align-items-center justify-content-between">
                  <%= link_to members_training_path(training), class: "stretched-link btn-nxr small" do %>
                    <i class="fas fa-search me-1"></i> Voir la fiche
                  <% end %>
                </div>
              </div>
            </article>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="card-homepage shadow-sm rounded-4 text-center p-5 mx-auto" style="max-width: 640px;">
      <div class="mb-3"><i class="far fa-calendar-times fa-3x"></i></div>
      <h3 class="h5 fw-bold mb-2">Aucun entraînement pour le moment</h3>
      <p class="mb-0">Dès qu’un entraînement est publié, il s’affiche ici.</p>
    </div>
  <% end %>
</section>

<!-- Événements -->
<section class="container my-5">
  <% has_events = @events.present? %>

  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <h2 class="mb-0 text-start fs-2 fw-bold text-uppercase">
      <i class="fas fa-calendar-alt me-2"></i>Les événements à venir
    </h2>
  </div>

  <% if has_events %>
    <div class="home-carousel"
     data-controller="home-carousel"
     data-home-carousel-step-value="item">
  <button type="button"
          class="home-carousel__nav home-carousel__nav--prev carousel-nav prev"
          data-action="click->home-carousel#prev"
          data-home-carousel-target="prevButton"
          aria-label="Précédent">‹</button>

  <button type="button"
          class="home-carousel__nav home-carousel__nav--next carousel-nav next"
          data-action="click->home-carousel#next"
          data-home-carousel-target="nextButton"
          aria-label="Suivant">›</button>

  <div class="home-carousel__track"
       data-home-carousel-target="track">
        <% @events.each do |event| %>
          <div class="home-carousel__item">
            <article class="card card-admin shadow-sm rounded-4 h-100 overflow-hidden">
              <div class="ratio ratio-4x3 bg-dark">
                <% if event.image&.attached? %>
                  <%= image_tag event.image, class: "card-img-top object-cover", alt: event.name %>
                <% else %>
                  <%= image_tag "logo_mcnc_3.png", class: "card-img-top object-contain p-3", alt: event.name %>
                <% end %>
              </div>

              <div class="card-body d-flex flex-column">
                <h3 class="h6 fw-bold mb-2"><%= event.name %></h3>
                <p class="text-tertiary small mb-3">
                  <i class="far fa-clock me-1"></i>
                  <%= l(event.date, format: "%d %B %Y") %>
                </p>

                <div class="mt-auto d-flex align-items-center justify-content-between">
                  <%= link_to members_event_path(event), class: "stretched-link btn-nxr small" do %>
                    <i class="fas fa-search me-1"></i> Voir la fiche
                  <% end %>
                </div>
              </div>
            </article>
          </div>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="card-homepage shadow-sm rounded-4 text-center p-5 mx-auto" style="max-width: 640px;">
      <div class="mb-3"><i class="far fa-calendar-times fa-3x"></i></div>
      <h3 class="h5 fw-bold mb-2">Aucun événement pour le moment</h3>
      <p class="mb-0">Dès qu’un événement est publié, il s’affiche ici.</p>
    </div>
  <% end %>
</section>

<!-- Mon profil -->
<% required = {
  "Téléphone" => current_user.phone_number,
  "Adresse"   => current_user.address,
  "Code postal" => current_user.post_code,
  "Ville"     => current_user.town,
  "N° licence" => current_user.license_number
} %>
<% missing = required.select { |_, v| v.blank? }.keys %>
<% total = required.size; done = total - missing.size %>
<% pct = total.zero? ? 0 : ((done.to_f / total) * 100).round %>
<% bar_class = pct == 100 ? "progress-bar progress-bar-green" : "progress-bar progress-bar-orange" %>

<section class="container my-5">
  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-4">
    <h2 class="mb-0 text-start fs-2 fw-bold text-uppercase">
      <i class="far fa-user-circle me-2"></i>Mon profil
    </h2>
  </div>

  <div class="row g-4">
    <div class="col-sm-10 col-md-8 col-lg-6 mx-auto">
      <article class="card card-admin shadow-sm rounded-4 h-100 overflow-hidden">
        <div class="card-body">
          <div class="d-flex align-items-center gap-3">
            <% if current_user.avatar&.attached? %>
              <%= image_tag current_user.avatar, class: "profile-avatar", alt: current_user.user_name %>
            <% else %>
              <%= image_tag "avatar_default.jpg", class: "profile-avatar", alt: current_user.user_name %>
            <% end %>

            <div class="flex-grow-1">
              <h3 class="h6 fw-bold mb-1"><%= current_user.first_name %> <%= current_user.last_name %></h3>
              <div class="inscriptions-progress">
                <div class="progress" role="progressbar" aria-label="Complétion du profil"
                     aria-valuenow="<%= pct %>" aria-valuemin="0" aria-valuemax="100">
                  <div class="<%= bar_class %>" style="width:<%= pct %>%"></div>
                </div>
                <small class="text-tertiary d-block mt-1">Profil complété à <%= pct %>%</small>
              </div>
            </div>
          </div>

          <% if missing.any? %>
            <hr class="my-3">
            <p class="small mb-2 text-tertiary">Champs à compléter :</p>
            <ul class="small mb-3 mb-0">
              <% missing.each do |label| %>
                <li><i class="far fa-circle-xmark me-1"></i><%= label %></li>
              <% end %>
            </ul>
          <% end %>

          <hr class="my-3">
          <%= link_to edit_user_registration_path, class: "btn-nxr d-inline-flex align-items-center" do %>
            <i class="fas fa-user-edit me-2"></i> Mettre à jour mes infos
          <% end %>
        </div>
      </article>
    </div>
  </div>
</section>
