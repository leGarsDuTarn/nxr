<div class="container d-flex justify-content-center align-items-start py-5">
  <div class="card-signup shadow p-4 p-md-5 rounded-4 w-100">
    <div class="d-flex justify-content-center mb-4">
      <h1 class="text-center"><strong>Modifier mon profil</strong></h1>
    </div>

    <%= simple_form_for(resource, as: resource_name, url: registration_path(resource_name), html: { method: :put }) do |f| %>
      <%= f.error_notification %>

      <% if devise_mapping.confirmable? && resource.pending_reconfirmation? %>
        <p class="text-center text-muted mb-4">
          En attente de confirmation pour : <%= resource.unconfirmed_email %>
        </p>
      <% end %>

      <!-- Identité -->
      <fieldset class="form-section mb-4">
        <legend class="section-title">Identité</legend>
        <div class="row g-3">
          <div class="col-md-6">
            <%= f.input :user_name, autofocus: true, required: true, placeholder: "Pseudo" %>
          </div>
          <div class="col-md-6">
            <%= f.input :birth_date, as: :date, required: true,
                        start_year: Date.current.year - 80,
                        end_year: Date.current.year - 10,
                        order: [:day, :month, :year],
                        prompt: { day: 'Jour', month: 'Mois', year: 'Année' } %>
          </div>
          <div class="col-md-6">
            <%= f.input :first_name, required: true, placeholder: "Prénom" %>
          </div>
          <div class="col-md-6">
            <%= f.input :last_name, required: true, placeholder: "Nom" %>
          </div>

         <div class="col-12">
          <%# Affiche l’avatar actuel uniquement si le blob est bien persisté %>
          <% if resource.avatar.attached? && resource.avatar.blob&.persisted? %>
            <div class="mb-2">
              <p class="mb-1">Avatar actuel :</p>
              <%= image_tag url_for(resource.avatar), size: "150x100", class: "img-thumbnail mb-2" %><br>
              <div class="form-check">
                <%= f.check_box :remove_avatar, class: "form-check-input" %>
                <%= f.label :remove_avatar, "Supprimer l'avatar actuel", class: "form-check-label" %>
              </div>
            </div>
          <% end %>

              <%= f.input :avatar, as: :file, required: false, hint: "Photo de profil (optionnel)." %>
            </div>
          </div>
        </fieldset>

      <!-- Coordonnées -->
      <fieldset class="form-section mb-4">
        <legend class="section-title">Coordonnées</legend>
        <div class="row g-3">
          <div class="col-md-6">
            <%= f.input :phone_number,
                        hint: "Recommandé - pour vous prévenir rapidement (annulation, urgence…)" %>
          </div>
          <div class="col-12">
            <%= f.input :address, required: true, placeholder: "N° et rue" %>
          </div>
          <div class="col-md-4">
            <%= f.input :post_code, required: true, placeholder: "Code postal" %>
          </div>
          <div class="col-md-8">
            <%= f.input :town, required: true, placeholder: "Ville" %>
          </div>
        </div>
      </fieldset>

      <!-- Club -->
      <fieldset class="form-section mb-4" data-controller="club-member-check">
        <legend class="section-title">Club</legend>
        <div class="row g-3">
          <div class="col-md-6">
            <%= f.input :club_member,
                        label: "Êtes-vous membre du club de Navès ?",
                        as: :select,
                        collection: [['Oui', true], ['Non', false]],
                        include_blank: "Sélectionner",
                        required: true,
                        input_html: {
                          data: {
                            "club-member-check-target": "select",
                            action: "change->club-member-check#toggle"
                          }
                        } %>
          </div>

          <!-- Affiché si Non -->
          <div class="col-md-6" data-club-member-check-target="clubNameWrapper" style="display:none;">
            <%= f.input :club_name, label: "Nom de votre club", placeholder: "Nom du club" %>
          </div>

          <!-- Affiché si Oui -->
          <div class="col-md-6" data-club-member-check-target="affiliationWrapper" style="display:none;">
            <%= f.input :club_affiliation_number, label: "N° d'affiliation du club de Navès" %>
          </div>
        </div>
      </fieldset>

      <!-- Licence -->
      <fieldset class="form-section mb-4">
        <legend class="section-title">Licence</legend>
        <div class="row g-3">
          <div class="col-md-6">
            <%= f.input :license_code, required: true, as: :select,
                        collection: User::LICENCE_CODES,
                        include_blank: "Sélectionner un code" %>
          </div>
          <div class="col-md-6">
            <%= f.input :license_number, required: true, placeholder: "Numéro à 6 chiffres" %>
          </div>
        </div>
      </fieldset>

      <!-- Sécurité -->
      <fieldset class="form-section mb-4">
        <legend class="section-title">Sécurité</legend>

        <!-- Changer le mot de passe -->
        <div class="mb-4">
          <div class="row g-3">
            <div class="col-md-6">
              <%= f.input :password, required: false,
                          hint: "Min. 8 caractères avec majuscule, minuscule, chiffre et caractère spécial.",
                          input_html: { autocomplete: "new-password" } %>
            </div>
            <div class="col-md-6">
              <%= f.input :password_confirmation, required: false,
                          input_html: { autocomplete: "new-password" } %>
            </div>
          </div>
        </div>


        <!-- Valider les modifications -->
        <div class="mt-4 pt-3 border-top">
          <h4 class="fw-bold mb-2">Valider mes modifications</h4>
          <p class="mb-3">
            Pour enregistrer vos changements, confirmez avec votre email et votre mot de passe actuel.
          </p>
          <div class="row g-3">
            <div class="col-md-6">
              <%= f.input :email, required: true, input_html: { autocomplete: "email" } %>
            </div>
            <div class="col-md-6">
              <%= f.input :current_password, required: true,
                          hint: "Mot de passe actuel requis pour confirmer vos modifications",
                          input_html: { autocomplete: "current-password" } %>
            </div>
          </div>
        </div>
      </fieldset>

      <div class="d-grid">
        <%= f.button :submit, "Valider", class: "btn-nxr btn-lg" %>
      </div>
    <% end %>

    <div class="text-center mt-4">
      <hr class="my-4">
      <h3>Supprimer mon compte</h3>
      <p>Attention, cette action est irréversible.</p>
      <%= button_to "Supprimer mon compte", registration_path(resource_name),
                    data: { turbo_confirm: "Êtes-vous sûr de vouloir supprimer votre compte ?" },
                    method: :delete,
                    class: "btn btn-danger" %>
    </div>
  </div>
</div>
